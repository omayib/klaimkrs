<html lang="en">
    <!-- https://5balloons.info/post-form-data-to-api-using-axios-in-vuejs/ 
    https://5balloons.info/post-form-data-to-api-using-axios-in-vuejs/
    https://codepen.io/edvaldolima/pen/evzWor
    https://gist.github.com/richardblondet/ce87a397ef669d4d25dd21ea02b9dda1
    https://jsfiddle.net/ankurk91/w8y8k5wo/
    https://serversideup.net/uploading-files-vuejs-axios/
    -->
<head>
  <title>Form konversi prodi Informatika 2022</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
   <link href="https://cdn.jsdelivr.net/npm/vue-loading-overlay@3/dist/vue-loading.css" rel="stylesheet">
   <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>  
   <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
   <script src="https://cdn.jsdelivr.net/npm/vue-loading-overlay@3"></script>
   <!-- or point to a specific vue-select release -->
<script src="https://unpkg.com/vue-select@3.0.0"></script>
<link rel="stylesheet" href="https://unpkg.com/vue-select@3.0.0/dist/vue-select.css">
   <meta name="referrer" content="same-origin">
</head>
<body>
<div class="container">
        <p style="text-align: center;"><img src="https://drive.google.com/u/0/uc?id=19wQb9EOG5DIQJ3jTppyQf6NWoVTw-kVj&amp;export=download" alt="" width="750" /></p>
        <h1 style="text-align: center;">PENGAJUAN KLAIM KONVERSI SKS - MBKM</h1>
</div>
<main class="container" id="app">  
    <loading :active.sync="visible" :can-cancel="true"></loading>
    <div class="panel-group">
        <div class="panel panel-warning">
          <div class="panel-heading">PENCARIAN</div>                 
          <div class="panel-body">
            <input v-model="access_id" placeholder="Surat Tugas">
            <button v-on:click="onClickButtonCari">Cari</button>
            <br>
            <p style="white-space: pre-line;">{{ access_id_message }}</p>
          </div>
        </div>
    </div>
  <div class="panel-group">
      <div class="panel panel-primary">
        <div class="panel-heading">STEP 1. PROFIL PESERTA</div>                 
        <div class="panel-body">  

            <form v-on:submit.prevent="submitEntry">
                <table>
                    <tbody>
                        <tr>
                            <td>
                                Nama 
                            </td>
                            <td>
                                <input v-model="profileDraft.name" placeholder="Nama lengkap">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                NIM
                            </td>
                            <td>
                                <input v-model="profileDraft.nim" placeholder="19.11.1155x">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                No. Surat Tugas
                            </td>
                            <td>
                                <input v-model="profileDraft.no_surat" placeholder="contoh : 01/FIK/BANGKIT/2022">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Email
                            </td>
                            <td>
                                <input v-model="profileDraft.email" placeholder="stefani@students.amikom.ac.id">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Kegiatan
                            </td>
                            <td>
                                <v-select 
                                :options="opsiKegiatan" 
                                label="title"
                                v-model="profileDraft.kegiatan"
                              ></v-select>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="form-group">
                    <button class="btn btn-primary">Submit</button>
                </div>
            </form>
        </div>

      </div>

  </div>
  <div class="panel-group">
    <div class="panel panel-primary">
        <div class="panel-heading">STEP 2. UNGGAH BUKTI KEGIATAN</div>                 
        <div class="panel-body">  
            <div class="container">
                <label>File Sertifikat
                    <input type="file" @change="handleFileUploadSertifikat( $event )"/>
                </label>
                <button class="btn btn-primary" @click="submitFileSertifikat" :disabled='profileIsEmpty()'>Submit</button>
            </div>  
            <div class="container">
                <label>File Kontrak Konversi
                    <input type="file"  @change="handleFileUploadKontrak( $event )"/>
                </label>
                <button class="btn btn-primary" @click="submitFileKontrak" :disabled='profileIsEmpty()'>Submit</button>
            </div>
            </div>
        </div>
    </div>
  </div>  
  <div class="panel-group">
    <div class="panel panel-primary">
     <div class="panel-heading">STEP 3. FORM KONVERSI</div>                  
        <div class="panel-body"> 
            <i class="fa fa-plus pull-right"  @click="addRow" style="font-size:25px;color:#337ab7;cursor:pointer"></i>
            
            <form v-on:submit.prevent="submitForm">
            <table class="table table-bordered">
            <thead class="text text-success">
                <tr>                            
                    <th>Objective</th>
                    <th>Durasi</th>
                    <th>Kode Matkul</th>
                    <th>Nama Matkul</th>
                    <th>SKS Matkul</th>
                    <th>Nilai Angka</th>
                    <th>Nilai Huruf</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for='(user, index) in items'>                            
                    <td>
                    <input  v-model="user.objective"  class="form-control" type="text" :disabled="user.status==='delete'" />
                    </td>
                    <td>
                    <input v-model="user.durasi" class="form-control" type="text" :disabled="user.status==='delete'" />
                    </td>
                    <td>
                    <input v-model="user.kode" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <input v-model="user.matkul" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <input v-model="user.sks" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <input v-model="user.angka" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <input v-model="user.huruf" class="form-control" type="text" :disabled="user.status==='delete'"/>
                    </td>
                    <td>
                    <i  @click="deleteRow(index)" class="fa fa-remove" style="font-size:25px;color:red;cursor:pointer"></i>
                    </td>
                </tr>                        
            </tbody>
            </table>
    
            <div class="form-group">
                <button class="btn btn-primary" :disabled='profileIsEmpty()'>Submit</button>
            </div>
            </form>
        </div> 
      </div>
    </div>
</main>
<script >
 Vue.use(VueLoading);
 Vue.component('v-select', VueSelect.VueSelect);
 const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true
    })
 var key="AKfycbyC8gSkitA2FN3n3DZziIMJla_4xSDRel5SEDiDNMmNXaI00Oa98Th-mWDC3N12YefX";
 var baseUrl=`https://script.google.com/macros/s/${key}/exec`;
 var app = new Vue({
     
   el: '#app',
   data: {
    opsiKegiatan:["Studi Independen","Magang Bersertifikat","Bangkit","Pertukaran Pelajar"],
    fileUrlSertifikat:"",
    fileUrlKontrakKonversi:"",   
    fileSertifikat:"",  
    fileKontrak:"",
    visible:false,
    access_id:"",
    access_id_message:"001/FIK-IF/AMIKOM/REK.STUIND/07/2021",
    profileDraft:{name:'',nim:'',kegiatan:'',email:'',no_surat:''},
    profile:{name:'',nim:'',kegiatan:'',email:'',no_surat:''},
    items:[{id:'',objective:'',durasi:'',kode:'',matkul:'',sks:'',angka:'',huruf:'',email:'',no_surat:'',status:''}]     
   },
    components: {
        Loading: VueLoading
    },
   methods: {
    profileIsEmpty,
    submitEntry,
    addRow: function() { 
  
       var randomId = Math.floor(100000 + Math.random() * 900000);
       this.items.push({id:randomId, objective:'',durasi:'',
                        kode:'',matkul:'',sks:'',
                        angka:'',huruf:'',email:app.profile.email,
                        no_surat:app.profile.no_surat,status:''});
        console.log("add "+this.items);
    },
    deleteRow(index){
        Swal.fire({
            title: 'Yakin dihapus?',
            text: "Proses tidak bisa diualng",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, hapus!'
            }).then((result) => {
            if (result.isConfirmed) {
                var item = this.items[index];
                item.status='delete'
                Vue.set(this.items,index,item)  

                Swal.fire(
                'Deleted!',
                'SKS Konversi berhasil dihapus.',
                'success'
                )
            }
            })   
        // var item = this.items[index];
        // item.status='delete'
        // Vue.set(this.items,index,item)        
    },
    submitForm,
    onClickButtonCari,
    submitFileKontrak,
    submitFileSertifikat,
    handleFileUploadSertifikat(event){
        this.fileSertifikat = event.target.files[0];
      },
    handleFileUploadKontrak(event){
        this.fileKontrak = event.target.files[0];
      }
   }  
  })
  function submitEntry(){
    var urlProfile = `${baseUrl}?action=8`;
      var dataTobeUpload ={
          nama:this.profileDraft.name,
          email:this.profileDraft.email,
          nim:this.profileDraft.nim,
          kegiatan:this.profileDraft.kegiatan,
          no_surat:this.profileDraft.no_surat
      }
    if(this.profileDraft.name ==="" || 
        this.profileDraft.email ==="" || 
        this.profileDraft.nim ===""|| 
        this.profileDraft.kegiatan ===""|| 
        this.profileDraft.no_surat ===""){
            Swal.fire(
                    'Ops!',
                    'data masih kosong',
                    'error'
                    )
    }else{
        Swal.fire({
            title: 'Data akan disimpan?',
            text: "Periksa dengan teliti",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Submit'
            })
            .then((result) => {
            if (result.isConfirmed) {
                let loader = this.$loading.show({
                    loader: 'dots'
                });
                axios({
                    method: "post",
                    url: urlProfile,
                    data: dataTobeUpload,
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                "Access-Control-Allow-Origin": "*"
                    })
                    .then(function (response) {
                        //handle success
                        loader.hide();
                        var _profil=response.data.data;
                        console.log(_profil);
                        if(_profil){
                            Toast.fire({
                                icon: 'success',
                                title: 'Profil berhasil diperbarui'
                                })
                            
                            app.profile.name=_profil.nama;
                            app.profile.nim=_profil.nim;
                            app.profile.kegiatan=_profil.kegiatan;
                            app.profile.email=_profil.email;
                            app.profile.no_surat=_profil.no_surat;

                            app.profileDraft.name=_profil.nama;
                            app.profileDraft.nim=_profil.nim;
                            app.profileDraft.kegiatan=_profil.kegiatan;
                            app.profileDraft.email=_profil.email;
                            app.profileDraft.no_surat=_profil.no_surat;
                        }else{
                            clearProfile();
                        }
                    })
                    .catch(function (response) {
                        //handle error
                        console.log(response);
                        loader.hide();
                    });

            }

        }) 
    }
    
                

  }
  function onClickButtonCari(){
        let loader = this.$loading.show({
                loader: 'dots'
            });
        var urlProfile = baseUrl+"?action=1&sr="+app.access_id;
        var urlKonversi = baseUrl+"?action=2&sr="+app.access_id;
        let endpoints = [urlProfile,urlKonversi];
        axios.all(endpoints.map((endpoint)=>axios.get(endpoint))).then(
            axios.spread((profile,konversi)=>{
                loader.hide();
                if(profile.data.data.length>0){
                    var _profil=profile.data.data.shift();
                    console.log(_profil);
                    app.profile.name=_profil.nama;
                    app.profile.nim=_profil.nim;
                    app.profile.kegiatan=_profil.jenis_rekomendasi;
                    app.profile.email=_profil.email;
                    app.profile.no_surat=_profil.no_surat;

                    app.profileDraft.name=_profil.nama;
                    app.profileDraft.nim=_profil.nim;
                    app.profileDraft.kegiatan=_profil.jenis_rekomendasi;
                    app.profileDraft.email=_profil.email;
                    app.profileDraft.no_surat=_profil.no_surat;
                }else{
                    clearProfile();
                    Swal.fire(
                    'Ops!',
                    'Profile tidak ditemukan. Lengkapi STEP 1',
                    'error'
                    )
                }
                if(konversi.data.data.length>0){
                    var _items=konversi.data.data;
                    app.items=[];
                    _items.forEach(function(e,i){
                        app.items.push({id:e.id,objective:e.objective,durasi:e.durasi,
                                    kode:e.kode_makul, sks:e.sks, matkul:e.makul,
                                    angka:e.angka,huruf:e.huruf,email:e.email,
                                    no_surat:e.no_surat});
                    });
                }
            })
        ).catch(function (error) {
                // handle error
                console.log(error);
                loader.hide()
            })
        .then(function () {
        });
 }   
 function submitForm(){
        // var baseUrl = `https://script.google.com/macros/s/${app.key}/exec`

        // var urlKonversi = app.baseUrl+"?action=insert";
        var urlKonversi = baseUrl+"?action=6";
        var payload = {items:app.items,profile:app.profile};
        console.log("payload");
       
        
        Swal.fire({
            title: 'Data akan disimpan?',
            text: "Periksa dengan teliti",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Submit'
            })
            .then((result) => {
            if (result.isConfirmed) {
                let loader = this.$loading.show({
                    loader: 'dots'
                });
                axios({
                    method: "post",
                    url: urlKonversi,
                    data: app.items,
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                "Access-Control-Allow-Origin": "*"
                    })
                    .then(function (response) {
                        //handle success
                        console.log(response);
                        loader.hide();
                        Toast.fire({
                            icon: 'success',
                            title: 'Konversi berhasil diperbarui'
                            })
                    })
                    .catch(function (response) {
                        //handle error
                        console.log(response);
                        Swal.fire('Ops!',
                            'Terjadi kesalahan, mungkin nomer surat tidak valid',
                            'error'
                            )
                        loader.hide();
                    });

            }

            }) 

        
 }
 function submitFileSertifikat(){
    if(!this.fileSertifikat){
        Swal.fire('Ops!',
                    'File sertifikat belum dipilih',
                    'error'
                    )
         return;
    }
    let loader = this.$loading.show({
                loader: 'dots'
            });
    const qs = new URLSearchParams({filename:this.fileSertifikat.name, 
                                    mimeType: this.fileSertifikat.type, 
                                    action:7,
                                    noSurat:this.profile.no_surat,
                                    jenis:'sertifikat'});
    const fr = new FileReader();
    fr.readAsArrayBuffer(this.fileSertifikat);
    fr.onload = f => {
        axios({
                method: "post",
                url: `${baseUrl}?${qs}`,
                data: JSON.stringify([...new Int8Array(f.target.result)])                               
            }).then(function(r){
                app.fileUrlSertifikat = r.data.fileUrl;
                console.log(JSON.stringify(r.data));
                loader.hide();
                Swal.fire(
                    'Good job!',
                    'Kamu berhasil mengunngah sertifikat',
                    'success'
                    )
                })
            .then(re=>{ loader.hide(); console.log(re)})
            .catch(error =>{ 
                loader.hide();  
                Swal.fire('Ops!',
                    'Terjadi kesalahan, mungkin nomer surat tidak valid',
                    'error'
                    )
                });
        
    }
 }
 function submitFileKontrak(){
    if(!this.fileKontrak){
        Swal.fire('Ops!',
                    'File kontrak konversi belum dipilih',
                    'error'
                    )
         return;
    }
    let loader = this.$loading.show({
                loader: 'dots'
            });
    const qs = new URLSearchParams({filename:this.fileKontrak.name, 
                                    mimeType: this.fileKontrak.type, 
                                    action:7,
                                    noSurat:this.profile.no_surat,
                                    jenis:'kontrakkonversi'});
    const fr = new FileReader();
    fr.readAsArrayBuffer(this.fileKontrak);
    fr.onload = f => {
        axios({
                method: "post",
                url: `${baseUrl}?${qs}`,
                data: JSON.stringify([...new Int8Array(f.target.result)])
            }).then(function(r){
                app.fileUrlKontrakKonversi = r.data.fileUrl;
                loader.hide();
                Swal.fire(
                    'Good job!',
                    'Kamu berhasil mengunngah kontrak konversi',
                    'success'
                    )
                })
            .then(re=> loader.hide())
            .catch(error =>{
                loader.hide();
                Swal.fire('Ops!',
                    'Terjadi kesalahan, mungkin nomer surat tidak valid',
                    'error'
                    )
            });
        
    }
 }
 function clearProfile(){
     app.profile.name="";
     app.profile.email="";
     app.profile.nim="";
     app.profile.kegiatan="";
     app.profile.no_surat="";
 }
 function profileIsEmpty(){
     return (this.profile.email==="" || this.profile.no_surat ==="")
 }
 </script>
 </body>
 </html> 